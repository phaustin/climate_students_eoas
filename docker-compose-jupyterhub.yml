version: '3.7'

# generated from https://github.com/phaustin/climate_modeling_eoas/blob/main/ansible/templates/jupyterhub/docker-compose-jupyterhub.j2
# see vars/jupyterhub_climate.yml for
# hub_service_name, dockerhub_id, container_version, hub_domain, JHUB_OAUTH_CALLBACK_URL
#  example:  hub_service_name: climatehub
#            dockerhub_id: phaustin
#            hub_image_name: climatehub
#            container_version: dec31
#            hub_domain: climhub.phaustin.org
#
services:

  climatehub:
    build:
        context: climatehub_image
        dockerfile: ./Dockerfile
    image: phaustin/climatehub:dec31
    container_name: climatehub_dec31
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - JHUB_OAUTH_CALLBACK_URL
      - JHUB_OAUTH_CLIENT_ID
      - JHUB_OAUTH_CLIENT_SECRET
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.climatehub.rule=Host(`climhub.phaustin.org`)"
      - traefik.http.routers.climatehub.tls=true
      - traefik.http.routers.climatehub.tls.certresolver=lets-encrypt
      - "traefik.http.routers.climatehub.service=climatehub"
      - "traefik.http.services.climatehub.loadbalancer.server.port=8000"
    restart: on-failure
    networks:
      - traefik_net


networks:
  traefik_net:
    external: true
