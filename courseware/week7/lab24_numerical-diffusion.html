

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>24. A peek at numerical methods for diffusion models &#8212; Climate Laboratory Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'courseware/week7/lab24_numerical-diffusion';</script>
    <link rel="canonical" href="https://phaustin.github.io/ClimateLaboratoryBook/courseware/week7/lab24_numerical-diffusion.html" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="25. Ice-albedo feedback and Snowball Earth in the EBM" href="../week8/lab25_albedo-snowball.html" />
    <link rel="prev" title="23. Atmospheric Dynamics in the CESM" href="lab23_cesm-atmospheric-dynamics.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../home.html">
  
  
  
  
  
    <p class="title logo__title">Climate Laboratory Book</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../home.html">
                    The Climate Laboratory
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Syllabus</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ugradsyllabus.html">Undergraduate Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gradsyllabus.html">Graduate Syllabus</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Weekly topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../week1_topics.html">Week 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../week2_topics.html">Week 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../week3_topics.html">Week 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../week4_topics.html">Week 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../week7_topics.html">Week 7</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Front matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../preamble.html">Preamble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About this Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../who-for.html">Who is the book for?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to.html">How to use this book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../attribution.html">How to cite and reuse this material</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extra_reading.html">Additional resources</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 1 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week1/lab1_models-budgets-fun.html">1. Climate models, the global energy budget, and Fun with Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 2 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../week2/lab2_zero-dim-ebm.html">2. Modeling the global energy budget</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week2/lab2_1_analytical-efolding.html">2.11. Advanced topic: Analytical solution of the global Energy Balance Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../week2/lab3_climate-system-models.html">3. The climate system and climate models</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 3 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week3/lab4_introducing-cesm.html">4. Introducing the Community Earth System Model (CESM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week3/lab5_climlab-intro.html">5. Building simple climate models using climlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week3/lab6_radiation.html">6. A Brief Review of Radiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week3/lab7_elementary-greenhouse.html">7. Elementary greenhouse models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week3/lab8_sympy-greenhouse.html">8. Advanced topic: Solving the two-layer grey gas model analytically with sympy</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 4 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week4/lab9_grey-radiation-climlab.html">9. Grey radiation modeling with climlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week4/lab10_radiative-transfer.html">10. Modeling non-scattering radiative transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week4/lab11_spectral-bands.html">11. Who needs spectral bands? We do. Some baby steps…</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 5 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week5/lab12_radeq.html">12. Radiative Equilibrium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week5/lab13_rce.html">13. Radiative-Convective Equilibrium</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../week5/lab14_sensitivity-feedback.html">14. Climate sensitivity and feedback</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week5/lab14_2_advanced-sensitivity-feedback.html">14.9. Advanced topic: Climate sensitivity and feedback</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../week5/lab15_transient-cesm.html">15. Examing the transient and equilibrium CO<span class="math notranslate nohighlight">\(_2\)</span> response in the CESM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week5/lab16_transient-toy.html">16. Toy models of transient warming</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 6 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week6/lab17_clouds.html">17. Clouds and cloud feedback</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week6/lab18_insolation.html">18. Insolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week6/lab19_orbital.html">19. Orbital variations, insolation, and the ice ages</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../week6/lab20_heat-transport.html">20. Heat transport</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week6/lab20_2_advanced-heat-transport.html">20.8. Advanced topic: Heat transport decomposition</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 7 Labs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lab21_one-dim-ebm.html">21. The one-dimensional energy balance model</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab22_seasonal-cycle.html">22. Modeling the seasonal cycle of surface temperature</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab23_cesm-atmospheric-dynamics.html">23. Atmospheric Dynamics in the CESM</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">24. A peek at numerical methods for diffusion models</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 8 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../week8/lab25_albedo-snowball.html">25. Ice-albedo feedback and Snowball Earth in the EBM</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week8/lab25_2_advanced-albedo-feedback.html">25.10. Advanced topic: Ice albedo feedback in the EBM – test2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week8/lab25_3_advanced-snowball-earth.html">25.11. Advanced topic: Snowball Earth and Large Ice Cap Instability in the EBM</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../week8/lab26_cesm-coupled-dynamics.html">26. Coupled Dynamics in the CESM</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 9 Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../week9/lab27_surface-energy-balance.html">The surface energy balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week9/lab28_land-ocean-contrast.html">Land-Ocean contrasts under climate change</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week9/lab29_water-water-everywhere.html">Water, water everywhere!</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Assignments</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../about-assignments.html">About the assignments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments/assignment1-zero-dim-ebm.html">Assignment: Climate change in the zero-dimensional EBM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments/assignment2-cesm-control.html">Assignment: Global average budgets in the CESM pre-industrial control simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments/assignment2-cesm-control-hints.html">Additional hints and guidance for CESM budgets assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments/assignment3-simple-clouds.html">Assignment: Clouds in the Leaky Greenhouse Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments/assignment4-rcm-feedback.html">Assignment: Feedbacks in the Radiative-Convective Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments/assignment5-cesm-climate-change.html">Assignment: Climate change in the CESM simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assignments/assignment6-insolation-orbit.html">Assignment: Insolation and orbital parameters</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">xarray tutorial</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../xarray/01-xarray-intro.html">Introduction to Xarray</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xarray/02-computation-masking.html">Computations and Masks with Xarray</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xarray/03-enso-xarray.html">Calculating ENSO with Xarray</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xarray/04-dask-arrays-xarray.html">Dask Arrays with Xarray</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Project resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../resources/resource_links.html">Project resources</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Extra notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/feedback_notation.html">Feedback notation for worksheet 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hydrostat.html">Hydrostatic balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hydrostatic_balance.html">Scale heights for typical atmospheric soundings</a></li>

<li class="toctree-l1"><a class="reference internal" href="../multi_layer_equilibrium.html">Radiative equilibrium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bayes_lecture.html">What I wish I’d known about statistics</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://climhub.phaustin.org/hub/user-redirect/git-pull?repo=https%3A//github.com/phaustin/ClimateLaboratoryBook&urlpath=tree/ClimateLaboratoryBook/content/courseware/week7/lab24_numerical-diffusion.md&branch=jb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/courseware/week7/lab24_numerical-diffusion.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../../_sources/courseware/week7/lab24_numerical-diffusion.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>A peek at numerical methods for diffusion models</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-one-dimensional-diffusion-equation">24.1. 1. The one-dimensional diffusion equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discretizing-the-diffusion-operator-in-space">24.2. 2. Discretizing the diffusion operator in space</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-notation-for-discretization-of-u-x-t">24.2.1. Some notation for discretization of <span class="math notranslate nohighlight">\(u(x,t)\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discretizing-the-diffusive-flux">24.2.2. Discretizing the diffusive flux</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#no-flux-boundary-conditions">24.2.3. No-flux boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-staggered-grid">24.2.4. The staggered grid</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-boundary-condition-on-the-staggered-grid">24.2.5. Implementing the boundary condition on the staggered grid</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-the-discretized-diffusion-operator-in-numpy">24.3. 3. Coding the discretized diffusion operator in <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-smooth-example">24.3.1. A smooth example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-non-smooth-examples">24.3.2. Some non-smooth examples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discretizing-the-time-derivative">24.4. 4. Discretizing the time derivative</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#now-suppose-that-you-wanted-to-double-the-spatial-resolution">24.4.1. Now, suppose that you wanted to <strong>double</strong> the spatial resolution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stability-analysis-of-the-ftcs-scheme">24.5. 5. Stability analysis of the FTCS scheme</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-wavy-solution-must-not-grow-with-time">24.5.1. The wavy solution must not grow with time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-have-just-discovered-an-important-constraint-on-the-allowable-timestep">24.5.2. We have just discovered an important constraint on the allowable timestep</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-tests-with-a-shorter-timestep">24.6. 6. Numerical tests with a shorter timestep</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-need-for-a-more-efficient-method">24.7. 7. The need for a more efficient method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implicit-time-method">24.8. 8. Implicit time method</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-implicit-scheme-as-a-matrix-problem">24.8.1. The implicit scheme as a matrix problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stability-analysis-of-the-implicit-scheme">24.8.2. Stability analysis of the implicit scheme</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#your-homework-assignment">24.9. 9. Your homework assignment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-final-thoughts">24.9.1. Some final thoughts:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#credits">24.10. Credits</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="a-peek-at-numerical-methods-for-diffusion-models">
<span id="nb-nummeth"></span><h1><span class="section-number">24. </span>A peek at numerical methods for diffusion models<a class="headerlink" href="#a-peek-at-numerical-methods-for-diffusion-models" title="Permalink to this headline">#</a></h1>
<p>This notebook is part of <a class="reference external" href="https://brian-rose.github.io/ClimateLaboratoryBook">The Climate Laboratory</a> by <a class="reference external" href="http://www.atmos.albany.edu/facstaff/brose/index.html">Brian E. J. Rose</a>, University at Albany.</p>
<hr class="docutils" />
<p><a id='section1'></a></p>
<section id="the-one-dimensional-diffusion-equation">
<h2><span class="section-number">24.1. </span>1. The one-dimensional diffusion equation<a class="headerlink" href="#the-one-dimensional-diffusion-equation" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>Suppose that a quantity <span class="math notranslate nohighlight">\(u(x)\)</span> is mixed down-gradient by a diffusive process.</p>
<p>The diffusive flux is</p>
<div class="math notranslate nohighlight">
\[ F = - K \frac{\partial u}{\partial x} \]</div>
<p>There will be local changes in <span class="math notranslate nohighlight">\(u\)</span> wherever this flux is convergent or divergent:</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} = - \frac{\partial F}{\partial x} \]</div>
<p>Putting this together gives the classical diffusion equation in one dimension</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} = \frac{\partial}{\partial x} \left( K \frac{\partial u}{\partial x} \right) \]</div>
<p>For simplicity, we are going to limit ourselves to Cartesian geometry rather than meridional diffusion on a sphere.</p>
<p>We will also assume here that <span class="math notranslate nohighlight">\(K\)</span> is a constant, so our governing equation is</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} = K \frac{\partial^2 u}{\partial x^2} \]</div>
<p>This equation represents a time-dependent diffusion process. It is an <strong>initial-boundary value problem</strong>. We want to integrate the model forward in time to model the changes in the field <span class="math notranslate nohighlight">\(u(x)\)</span>.</p>
<hr class="docutils" />
<p><a id='section2'></a></p>
</section>
<section id="discretizing-the-diffusion-operator-in-space">
<h2><span class="section-number">24.2. </span>2. Discretizing the diffusion operator in space<a class="headerlink" href="#discretizing-the-diffusion-operator-in-space" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>Solving a differential equation on a computer always requires some approximation to represent the continuous function <span class="math notranslate nohighlight">\(u(x,t)\)</span> and its derivatives in terms of discrete quantities (arrays of numbers).</p>
<p>We have already dealt with simple discretization of the time derivative back in [Lecture 2](./Lecture02 – Solving the zero-dimensional EBM.ipynb). We used the <strong>forward Euler</strong> method to step all our of radiation models forward in time so far.</p>
<section id="some-notation-for-discretization-of-u-x-t">
<h3><span class="section-number">24.2.1. </span>Some notation for discretization of <span class="math notranslate nohighlight">\(u(x,t)\)</span><a class="headerlink" href="#some-notation-for-discretization-of-u-x-t" title="Permalink to this headline">#</a></h3>
<p>We will discretize time and space on grids</p>
<div class="math notranslate nohighlight">
\[ x_j , ~~~ t^n \]</div>
<p>so that</p>
<div class="math notranslate nohighlight">
\[ u_j^n = u(x_j, ~t^n) \]</div>
</section>
<section id="discretizing-the-diffusive-flux">
<h3><span class="section-number">24.2.2. </span>Discretizing the diffusive flux<a class="headerlink" href="#discretizing-the-diffusive-flux" title="Permalink to this headline">#</a></h3>
<p>The governing equation can be written in terms of the convergence of the diffusive flux:</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} = - \frac{\partial F}{\partial x} \]</div>
<p>It is sensible to use a <strong>centered difference</strong> to approximate this derivative:</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial F}{\partial x} \bigg|_j \approx  \frac{F_{j+\frac{1}{2}} - F_{j-\frac{1}{2}}}{x_{j+\frac{1}{2}} - x_{j-\frac{1}{2}}} \]</div>
<p>The time tendency at point <span class="math notranslate nohighlight">\(x_j\)</span> can thus be written</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_j  \approx - \frac{F_{j+\frac{1}{2}} - F_{j-\frac{1}{2}}}{x_{j+\frac{1}{2}} - x_{j-\frac{1}{2}}} \]</div>
<p>The flux itself depends on a spatial derivative of <span class="math notranslate nohighlight">\(u\)</span>. We will apply the same centered difference approximation. At point <span class="math notranslate nohighlight">\(x_j\)</span> this would look like</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial x} \approx \frac{u_{j+\frac{1}{2}} - u_{j-\frac{1}{2}}}{x_{j+\frac{1}{2}} - x_{j-\frac{1}{2}}} \]</div>
<p>But we actually want to approximate <span class="math notranslate nohighlight">\(F_{j+\frac{1}{2}}\)</span> and <span class="math notranslate nohighlight">\(F_{j-\frac{1}{2}}\)</span>, so we apply the centered difference formula at these intermediate points to get</p>
<div class="math notranslate nohighlight">
\[ F_{j+\frac{1}{2}} \approx -K \frac{u_{j+1} - u_{j}}{x_{j+1} - x_{j}} \]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[ F_{j-\frac{1}{2}} \approx -K \frac{u_{j} - u_{j-1}}{x_{j} - x_{j-1}} \]</div>
<p>Putting this all together, we can write the time tendency at <span class="math notranslate nohighlight">\(x_j\)</span> as</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_j  \approx K \frac{ \frac{u_{j+1} - u_{j}}{x_{j+1} - x_{j}} - \frac{u_{j} - u_{j-1}}{x_{j} - x_{j-1}}}{x_{j+\frac{1}{2}} - x_{j-\frac{1}{2}}} \]</div>
<p>We’ll make things easy on ourselves by using uniform grid spacing in <span class="math notranslate nohighlight">\(x\)</span>, so</p>
<div class="math notranslate nohighlight">
\[ x_{j+1} - x_{j} = x_{j} - x_{j-1} = x_{j+\frac{1}{2}} - x_{j-\frac{1}{2}} = \Delta x \]</div>
<p>So our final formula for the diffusive flux convergence is</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_j  \approx K \frac{ u_{j+1} - 2 u_{j} + u_{j-1}}{\Delta x^2} \]</div>
</section>
<section id="no-flux-boundary-conditions">
<h3><span class="section-number">24.2.3. </span>No-flux boundary conditions<a class="headerlink" href="#no-flux-boundary-conditions" title="Permalink to this headline">#</a></h3>
<p>Suppose the domain is <span class="math notranslate nohighlight">\(0 \le x \le 1\)</span>, with solid walls at <span class="math notranslate nohighlight">\(x=0, 1\)</span>.</p>
<p>The physical boundary condition at the walls is that there can be no flux in or out of the walls:</p>
<div class="math notranslate nohighlight">
\[ F(0) = F(1) = 0 \]</div>
<p>So the boundary conditions on <span class="math notranslate nohighlight">\(u\)</span> are</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial x} = 0 ~~~ \text{at} ~~~ x=0,1 \]</div>
</section>
<section id="the-staggered-grid">
<h3><span class="section-number">24.2.4. </span>The staggered grid<a class="headerlink" href="#the-staggered-grid" title="Permalink to this headline">#</a></h3>
<p>Suppose we have a grid of <span class="math notranslate nohighlight">\(J+1\)</span> total points between <span class="math notranslate nohighlight">\(x=0\)</span> and <span class="math notranslate nohighlight">\(x=1\)</span>, <strong>including the boundaries</strong>:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(x^*_0 = 0 \)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x^*_1 = \Delta x\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x^*_2 = 2~\Delta x\)</span></p></li>
<li><p>…</p></li>
<li><p><span class="math notranslate nohighlight">\(x^*_j = j~\Delta x\)</span></p></li>
<li><p>…</p></li>
<li><p><span class="math notranslate nohighlight">\(x^*_{J-1} = (J-1)~\Delta x = 1 - \Delta x \)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x^*_J = J ~ \Delta x = 1 \)</span></p></li>
</ul>
<p>Clearly then the grid spacing must be <span class="math notranslate nohighlight">\(\Delta x = 1/J\)</span>.</p>
<p>We’ll define the fluxes on this grid. The boundary conditions can thus be written</p>
<div class="math notranslate nohighlight">
\[ F_0 = F_J = 0 \]</div>
<p>Since our centered difference discretization defines <span class="math notranslate nohighlight">\(F\)</span> at points halfway between the <span class="math notranslate nohighlight">\(u\)</span> points, it is sensible to locate <span class="math notranslate nohighlight">\(u\)</span> on another grid that is offset by <span class="math notranslate nohighlight">\(\Delta x / 2\)</span>.</p>
<p>The first grid point for <span class="math notranslate nohighlight">\(u\)</span> is thus a distance <span class="math notranslate nohighlight">\(\Delta x / 2\)</span> from the wall, and there are a total of <span class="math notranslate nohighlight">\(J\)</span> points:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(x_0 = \Delta x / 2\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x_1 = \Delta x / 2 + \Delta x\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x_2 = \Delta x / 2 + 2~\Delta x\)</span></p></li>
<li><p>…</p></li>
<li><p><span class="math notranslate nohighlight">\(x_j = \Delta x / 2 + j~\Delta x\)</span></p></li>
<li><p>…</p></li>
<li><p><span class="math notranslate nohighlight">\(x_{J-1} = \Delta x / 2 + (J-1)~\Delta x = 1 - \Delta x / 2 \)</span></p></li>
</ul>
</section>
<section id="implementing-the-boundary-condition-on-the-staggered-grid">
<h3><span class="section-number">24.2.5. </span>Implementing the boundary condition on the staggered grid<a class="headerlink" href="#implementing-the-boundary-condition-on-the-staggered-grid" title="Permalink to this headline">#</a></h3>
<p>At <span class="math notranslate nohighlight">\(x_0\)</span> we have</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_0  \approx -\frac{ F_1 - F_0}{\Delta x} \]</div>
<p>Subbing in <span class="math notranslate nohighlight">\(F_0 = 0\)</span> and the normal discretization for <span class="math notranslate nohighlight">\(F_1\)</span> gives</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_0  \approx K \frac{ u_1 - u_0 }{\Delta x^2} \]</div>
<p>The same procedure at the other wall yields</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_{J-1}  \approx - K \frac{ u_{J-1} - u_{J-2} }{\Delta x^2} \]</div>
<p>Pulling this all together we have a complete discretization of the diffusion operator including its boundary conditions:</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_0  \approx K \frac{ u_1 - u_0 }{\Delta x^2} \]</div>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_j  \approx K \frac{ u_{j+1} - 2 u_{j} + u_{j-1}}{\Delta x^2}, ~~~~~~ j=1,...,J-2 \]</div>
<div class="math notranslate nohighlight">
\[ \frac{\partial u}{\partial t} \bigg|_{J-1}  \approx - K \frac{ u_{J-1} - u_{J-2} }{\Delta x^2} \]</div>
<hr class="docutils" />
<p><a id='section3'></a></p>
</section>
</section>
<section id="coding-the-discretized-diffusion-operator-in-numpy">
<h2><span class="section-number">24.3. </span>3. Coding the discretized diffusion operator in <code class="docutils literal notranslate"><span class="pre">numpy</span></code><a class="headerlink" href="#coding-the-discretized-diffusion-operator-in-numpy" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Math</span><span class="p">,</span> <span class="n">Latex</span>
</pre></div>
</div>
</div>
</div>
<p>Here we will divide our domain up into 20 grid points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">J1</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">J1</span>
<span class="n">deltax</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">J</span>
<span class="n">display</span><span class="p">(</span><span class="n">Math</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;J = </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">J</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Math</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\Delta x = </span><span class="si">%0.3f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">deltax</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The fluxes will be solved on the staggered grid with 21 points.</p>
<p><span class="math notranslate nohighlight">\(u\)</span> will be solved on the 20 point grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xstag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xstag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s one way to implement the finite difference, using array indexing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dudx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dudx</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>We can also use the function <code class="docutils literal notranslate"><span class="pre">numpy.diff()</span></code> to accomplish the same thing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a function that computes the diffusive flux <span class="math notranslate nohighlight">\(F\)</span> on the staggered grid, including the boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">diffusive_flux</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1">#  Take the finite difference</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">/</span><span class="n">deltax</span>
    <span class="c1">#  add a zero as the first element (no flux on boundary)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="c1">#  add another zero as the last element (no flux on boundary)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="c1">#  flux is DOWN gradient, proportional to D</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">K</span><span class="o">*</span><span class="n">F</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">diffusive_flux</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">deltax</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>The time tendency of <span class="math notranslate nohighlight">\(u\)</span> is just the convergence of this flux, which requires one more finite difference:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">diffusion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1">#  compute flux</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">diffusive_flux</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="c1">#  take convergence of flux</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">/</span> <span class="n">deltax</span>
</pre></div>
</div>
</div>
</div>
<section id="a-smooth-example">
<h3><span class="section-number">24.3.1. </span>A smooth example<a class="headerlink" href="#a-smooth-example" title="Permalink to this headline">#</a></h3>
<p>Suppose we have an initial <span class="math notranslate nohighlight">\(u\)</span> field that has a local maximum in the interior.</p>
<p>The gaussian (bell curve) function is a convenient way to create such a field.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">std</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">std</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">)</span>
<span class="n">dudt</span> <span class="o">=</span> <span class="n">diffusion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$u(x)$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dudt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$du/dt$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Hopefully this makes sense. The diffusion is acting to smooth out <span class="math notranslate nohighlight">\(u\)</span> by reducing the peak and increasing <span class="math notranslate nohighlight">\(u\)</span> on the flanks of the gaussian bump.</p>
</section>
<section id="some-non-smooth-examples">
<h3><span class="section-number">24.3.2. </span>Some non-smooth examples<a class="headerlink" href="#some-non-smooth-examples" title="Permalink to this headline">#</a></h3>
<p>Use a random number generator to create some noisy initial conditions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
    <span class="n">dudt</span> <span class="o">=</span> <span class="n">diffusion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dudt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><a id='section4'></a></p>
</section>
</section>
<section id="discretizing-the-time-derivative">
<h2><span class="section-number">24.4. </span>4. Discretizing the time derivative<a class="headerlink" href="#discretizing-the-time-derivative" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>The simplest way to discretize the time derivative is the <strong>forward Euler</strong> method:</p>
<div class="math notranslate nohighlight">
\[ \frac{d u}{dt} \bigg|^n \approx \frac{u^{n+1} - u^n}{\Delta t} \]</div>
<p>We have already used this method to step our prognostic variables forward in time.</p>
<p>Solving the above for the future value of <span class="math notranslate nohighlight">\(u\)</span> gives</p>
<div class="math notranslate nohighlight">
\[ u^{n+1} = u^n + \Delta t \frac{d u}{dt} \bigg|^n \]</div>
<p>We apply our discretization of the diffusion operator to the current value of the field <span class="math notranslate nohighlight">\(u^n_j\)</span>, to get our formula for the future values:</p>
<div class="math notranslate nohighlight">
\[ u_j^{n+1} = u_j^n + \frac{K \Delta t}{\Delta x^2} \left( u^n_{j+1} - 2 u^n_{j} + u^n_{j-1} \right)  \]</div>
<p>(except at the boundaries, where the diffusion operator is slightly different – see above).</p>
<p>Together, this scheme is known as <strong>Forward Time, Centered Space</strong> or <strong>FTCS</strong>.</p>
<p>It is very simple to implement in <code class="docutils literal notranslate"><span class="pre">numpy</span></code> code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">step_forward</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">dudt</span> <span class="o">=</span> <span class="n">diffusion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span> <span class="o">+</span> <span class="n">deltat</span> <span class="o">*</span> <span class="n">dudt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">deltat</span> <span class="o">=</span> <span class="mf">0.125</span>
<span class="n">deltat1</span> <span class="o">=</span> <span class="n">deltat</span>

<span class="n">u0</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">)</span>
<span class="n">u1</span> <span class="o">=</span> <span class="n">step_forward</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltat1</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;next&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s loop through a number of timesteps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  regular resolution</span>
<span class="n">J</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">deltax</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">J</span>
<span class="n">xstag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xstag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">)</span>
<span class="n">niter</span> <span class="o">=</span> <span class="mi">11</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">step_forward</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltat1</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The numerics were easy to implement, and the scheme seems to work very well! The results are physically sensible.</p>
<section id="now-suppose-that-you-wanted-to-double-the-spatial-resolution">
<h3><span class="section-number">24.4.1. </span>Now, suppose that you wanted to <strong>double</strong> the spatial resolution<a class="headerlink" href="#now-suppose-that-you-wanted-to-double-the-spatial-resolution" title="Permalink to this headline">#</a></h3>
<p>Try setting <span class="math notranslate nohighlight">\(J=40\)</span> and repeat the above procedure.</p>
<p>What happens?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  double the resolution</span>
<span class="n">scaling_factor</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">J1</span> <span class="o">*</span> <span class="n">scaling_factor</span>
<span class="n">deltax</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">J</span>
<span class="n">xstag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xstag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">step_forward</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltat1</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Suddenly our scheme is producing numerical noise that grows in time and overwhelms to smooth physical solution we are trying to model.</p>
<p><strong>This is bad!</strong></p>
<p>What went wrong, and what can we do about it?</p>
<hr class="docutils" />
<p><a id='section5'></a></p>
</section>
</section>
<section id="stability-analysis-of-the-ftcs-scheme">
<h2><span class="section-number">24.5. </span>5. Stability analysis of the FTCS scheme<a class="headerlink" href="#stability-analysis-of-the-ftcs-scheme" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>Following Press et al. (1988), “Numerical Recipes in C: The Art of Scientific Computing”, Cambridge University Press.</p>
<p>This is an example of the so-called <strong>von Neumann Stability Analysis</strong>. It is a form of <em>normal mode</em> analysis for a discrete system.</p>
<p>We look for normal mode solutions (i.e. wavy sines and cosines) of the finite difference equations of the form</p>
<div class="math notranslate nohighlight">
\[ u_j^n = \xi^n \exp(i~k~j~ \Delta x) \]</div>
<p>where <span class="math notranslate nohighlight">\(k\)</span> is some real number that represents a spatial wavenumber (which can have any value), and <span class="math notranslate nohighlight">\(\xi = \xi(k)\)</span> is a complex number that depends on <span class="math notranslate nohighlight">\(k\)</span>.</p>
<p>The number <span class="math notranslate nohighlight">\(\xi\)</span> is called the <strong>amplification factor</strong> at a given wavenumber <span class="math notranslate nohighlight">\(k\)</span>.</p>
<p>The question is, <strong>under what conditions do wavy solutions grow with time</strong>?  (This is bad, as it means small numerical noise will become large numerical noise and make our differencing scheme unusable)</p>
<p>Let’s substitute the normal mode solution into our finite difference equation</p>
<div class="math notranslate nohighlight">
\[ \frac{u_j^{n+1} -  u_j^n}{\Delta t} = \frac{K}{\Delta x^2} \left( u^n_{j+1} - 2 u^n_{j} + u^n_{j-1} \right)  \]</div>
<div class="math notranslate nohighlight">
\[ \frac{\xi^{n+1} \exp(i~k~j~ \Delta x) -  \xi^n \exp(i~k~j~ \Delta x)}{\Delta t} = \frac{K}{\Delta x^2} \left( \xi^n \exp(i~k~(j+1)~ \Delta x) - 2 \xi^n \exp(i~k~j~ \Delta x) + \xi^n \exp(i~k~(j-1)~ \Delta x) \right)  \]</div>
<p>Divide through by <span class="math notranslate nohighlight">\(\xi^n \exp(i~k~j~\Delta x)\)</span>:</p>
<div class="math notranslate nohighlight">
\[ \frac{\xi^{n+1}}{\xi^n} -  1 = \frac{K \Delta t}{\Delta x^2} \left(\exp(i~k~\Delta x) - 2 + \exp(-i~k~\Delta x) \right)  \]</div>
<p>The exponentials simplify</p>
<div class="math notranslate nohighlight">
\[ \frac{\xi^{n+1}}{\xi^n} = 1 + \frac{K \Delta t}{\Delta x^2} \left(2 \cos(k~\Delta x) - 2 \right)  \]</div>
<p>Or using a double angle identity,</p>
<div class="math notranslate nohighlight">
\[ \frac{\xi^{n+1}}{\xi^n} = 1 - \frac{4 K \Delta t}{\Delta x^2} \sin^2 \left( \frac{k~\Delta x}{2} \right)  \]</div>
<section id="the-wavy-solution-must-not-grow-with-time">
<h3><span class="section-number">24.5.1. </span>The wavy solution must not grow with time<a class="headerlink" href="#the-wavy-solution-must-not-grow-with-time" title="Permalink to this headline">#</a></h3>
<p>We need to prevent growing normal modes. So successive amplitudes should be</p>
<div class="math notranslate nohighlight">
\[ \bigg| \frac{\xi^{n+1}}{\xi^n} \bigg| \le 1 \]</div>
<p>The stability condition is thus</p>
<div class="math notranslate nohighlight">
\[ \bigg| 1 - \frac{4 K \Delta t}{\Delta x^2} \sin^2 \left( \frac{k~\Delta x}{2} \right) \bigg| \le 1 \]</div>
<p>and this condition must be met for <strong>EVERY</strong> possible wavenumber <span class="math notranslate nohighlight">\(k\)</span>.</p>
<p>Because <span class="math notranslate nohighlight">\(0 \le \sin^2(\phi) \le 1\)</span> for any <span class="math notranslate nohighlight">\(\phi\)</span>, our condition can only be violated if</p>
<div class="math notranslate nohighlight">
\[ \frac{4 K \Delta t}{\Delta x^2} &gt; 2 \]</div>
<p>We conclude the the FTCS scheme is stable so long as this stability condition is met:</p>
<div class="math notranslate nohighlight">
\[ \Delta t \le \frac{\Delta x^2}{2 K} \]</div>
</section>
<section id="we-have-just-discovered-an-important-constraint-on-the-allowable-timestep">
<h3><span class="section-number">24.5.2. </span>We have just discovered an important constraint on the allowable timestep<a class="headerlink" href="#we-have-just-discovered-an-important-constraint-on-the-allowable-timestep" title="Permalink to this headline">#</a></h3>
<p>The maximum timestep we can use with the FTCS scheme for the diffusion equation is proportional to <span class="math notranslate nohighlight">\(\Delta x^2\)</span>.</p>
<p><strong>A doubling of the spatial resolution would require a 4x shorter timestep to preserve numerical stability.</strong></p>
<p>Physically, the restriction is that the maximum allowable timestep is approximately the diffusion time across a grid cell of width <span class="math notranslate nohighlight">\(\Delta x\)</span>.</p>
<hr class="docutils" />
<p><a id='section6'></a></p>
</section>
</section>
<section id="numerical-tests-with-a-shorter-timestep">
<h2><span class="section-number">24.6. </span>6. Numerical tests with a shorter timestep<a class="headerlink" href="#numerical-tests-with-a-shorter-timestep" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>Going back to our Gaussian example, let’s double the resolution but shorten the timestep by a factor of 4.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  double the resolution</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">J1</span> <span class="o">*</span> <span class="n">scaling_factor</span>
<span class="n">deltax</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">J</span>
<span class="n">xstag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xstag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="c1">#  The maximum stable timestep</span>
<span class="n">deltat_max</span> <span class="o">=</span> <span class="n">deltax</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">K</span>
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;The maximum allowable timestep is </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">deltat_max</span><span class="p">)</span>

<span class="n">deltat</span> <span class="o">=</span> <span class="n">deltat1</span> <span class="o">/</span> <span class="n">scaling_factor</span><span class="o">**</span><span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;4x the previous timestep is </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">deltat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">scaling_factor</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">step_forward</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Success! The graph now looks like a smoother (higher resolution) version of our first integration with the coarser grid.</p>
<p><strong>But at a big cost</strong>:  our calculation required 4 times more timesteps to do the same integration.</p>
<p>The total increase in computational cost was actally a factor of 8 to get a factor of 2 increase in spatial resolution.</p>
<hr class="docutils" />
<p><a id='section7'></a></p>
</section>
<section id="the-need-for-a-more-efficient-method">
<h2><span class="section-number">24.7. </span>7. The need for a more efficient method<a class="headerlink" href="#the-need-for-a-more-efficient-method" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>In practice the condition</p>
<div class="math notranslate nohighlight">
\[ \Delta t \le \frac{\Delta x^2}{2 K} \]</div>
<p>is often too restrictive to be practical!</p>
<p>Consider our diffusive EBM. Suppose we want a spatial resolution of 1º latitude. Then we have 180 grid points from pole to pole, and our physical length scale is</p>
<div class="math notranslate nohighlight">
\[ \Delta x \approx 10^5 \text{m} \]</div>
<p>We were using a diffusivity of <span class="math notranslate nohighlight">\(D = 0.6 ~ \text{W m}^{-2}~\text{K}^{-1}\)</span> and a heat capacity of <span class="math notranslate nohighlight">\(C = 4 \times 10^7 ~ \text{J m}^{-2} ~\text{K}^{-1}\)</span> (for 10 m of water, <span class="xref myst">see Lecture 17</span>).</p>
<p>Accounting for the spherical geometry in our EBM, this translates to</p>
<div class="math notranslate nohighlight">
\[ K = \frac{2 \pi a^2 D}{C} = \frac{2 \pi ~ (6.4 \times 10^6 ~\text{m})^2 ~(0.6 ~ \text{W m}^{-2}~\text{K}^{-1})}{4 \times 10^7 ~ \text{J m}^{-2} ~\text{K}^{-1}} \approx 4 \times 10^{6} ~ \text{m}^2 ~ \text{s}^{-1} \]</div>
<p>Recall that this is the diffusivity associated with the large-scale motion of the atmosphere (mostly). If we take a typical velocity scale for a mid-latitude eddy, <span class="math notranslate nohighlight">\(V \approx 20~\text{m s}^{-1}\)</span>, and a typical length scale for that eddy, <span class="math notranslate nohighlight">\(L \approx 2000~\text{km}\)</span>, the diffusivity then scales as</p>
<div class="math notranslate nohighlight">
\[ K = V~ L = 4 \times 10^{6} ~ \text{m}^2 ~ \text{s}^{-1} \]</div>
<p>Using these numbers the stability condition is roughly</p>
<div class="math notranslate nohighlight">
\[ \Delta t \le 10^3 ~\text{s}\]</div>
<p>which is less than one hour!</p>
<p>And if we wanted to double the resolution to 0.5º, we would need a timestep of just a few minutes.</p>
<p>This can be a very onerous requirement for a model that would like to integrate out for many years.  <strong>We can do better, but we need a different time discretization!</strong></p>
<hr class="docutils" />
<p><a id='section8'></a></p>
</section>
<section id="implicit-time-method">
<h2><span class="section-number">24.8. </span>8. Implicit time method<a class="headerlink" href="#implicit-time-method" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>With numerical methods for partial differential equations, it often turns out that a small change in the discretization can make an enormous difference in the results.</p>
<p>The <strong>implicit time</strong> scheme applies exactly the same centered difference scheme to the spatial derivatives in the diffusion operator.</p>
<p>But instead of applying the operator to the field <span class="math notranslate nohighlight">\(u^n\)</span> at time <span class="math notranslate nohighlight">\(n\)</span>, we instead apply it to the field <strong>at the future time</strong> <span class="math notranslate nohighlight">\(u^{n+1}\)</span>.</p>
<p>The scheme looks like</p>
<div class="math notranslate nohighlight">
\[ \frac{u_j^{n+1} - u_j^n}{\Delta t} =  \frac{K}{\Delta x^2} \left( u^{n+1}_{j+1} - 2 u^{n+1}_{j} + u^{n+1}_{j-1} \right)  \]</div>
<p>in the interior, and at the boundaries:</p>
<div class="math notranslate nohighlight">
\[ \frac{u_0^{n+1} - u_0^n}{\Delta t} = \frac{K}{\Delta x^2} \left( u^{n+1}_1 - u^{n+1}_0 \right) \]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[ \frac{u_{J-1}^{n+1} - u_{J-1}^n}{\Delta t} = - \frac{K}{\Delta x^2} \left( u_{J-1}^{n+1} - u_{J-2}^{n+1} \right) \]</div>
<p>This might seem like a strange way to write the system, since <strong>we don’t know the future state of the system at <span class="math notranslate nohighlight">\(t^{n+1}\)</span></strong>. That’s what we’re trying to solve for!</p>
<p>Let’s move all terms evaluated at <span class="math notranslate nohighlight">\(t^{n+1}\)</span> to the left hand side:</p>
<div class="math notranslate nohighlight">
\[ u_j^{n+1}  - \frac{K \Delta t}{\Delta x^2} \left( u^{n+1}_{j+1} - 2 u^{n+1}_{j} + u^{n+1}_{j-1} \right) = u_j^n   \]</div>
<p>or</p>
<div class="math notranslate nohighlight">
\[ -K^* u^{n+1}_{j+1} + \left(1+2K^* \right) u_j^{n+1} - K^* u_{j-1}^{n+1} = u_j^n \]</div>
<p>(in the interior)</p>
<p>where we have introduced a non-dimensional diffusivity</p>
<div class="math notranslate nohighlight">
\[ K^* = \frac{K \Delta t}{\Delta x^2} \]</div>
<section id="the-implicit-scheme-as-a-matrix-problem">
<h3><span class="section-number">24.8.1. </span>The implicit scheme as a matrix problem<a class="headerlink" href="#the-implicit-scheme-as-a-matrix-problem" title="Permalink to this headline">#</a></h3>
<p>We can write this as a matrix equation</p>
<div class="math notranslate nohighlight">
\[ \mathbf{A} ~ \mathbf{U}^{n+1} = \mathbf{U}^n \]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{U}\)</span> is a <span class="math notranslate nohighlight">\(J\times1\)</span> column vector giving the field <span class="math notranslate nohighlight">\(u(x)\)</span> at a particular instant in time:</p>
<div class="math notranslate nohighlight">
\[\begin{split} \mathbf{U}^n = \left[ \begin{array}{c} 
u^n_0 \\
u^n_1  \\
u^n_2 \\
...  \\
u^n_{J-2} \\
u^n_{J-1} \\
\end{array}
\right] 
\end{split}\]</div>
<p>and <span class="math notranslate nohighlight">\(\mathbf{U}^{n+1}\)</span> is the same vector at <span class="math notranslate nohighlight">\(t^{n+1}\)</span>.</p>
<p><span class="math notranslate nohighlight">\(\mathbf{A}\)</span> is a <span class="math notranslate nohighlight">\(J\times J\)</span> tridiagonal matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split} \mathbf{A} = \left[ \begin{array}{cccccccc}
 1+K^* &amp; -K^* &amp; 0 &amp; 0 &amp; ... &amp; 0 &amp; 0 &amp; 0 \\
 -K^* &amp; 1+2K^* &amp; -K^* &amp; 0 &amp; ... &amp; 0 &amp; 0 &amp; 0 \\
 0 &amp; -K^* &amp; 1+2K^* &amp; -K^* &amp;... &amp; 0 &amp; 0 &amp; 0 \\
 ... &amp; ... &amp; ... &amp; ... &amp; ... &amp; ... &amp; ... &amp; ... \\
 0 &amp; 0 &amp; 0 &amp; 0 &amp; ... &amp; -K^* &amp; 1+2K^* &amp; -K^* \\
 0 &amp; 0 &amp; 0 &amp; 0 &amp; ... &amp; 0 &amp; -K^* &amp; 1+K^* \\
\end{array}
\right] 
\end{split}\]</div>
<p>Solving for the future state of the system <span class="math notranslate nohighlight">\(\mathbf{U}^{n+1}\)</span> is then just the solution of the linear system</p>
<div class="math notranslate nohighlight">
\[ \mathbf{U}^{n+1} = \mathbf{A}^{-1} \mathbf{U}^{n}\]</div>
<p>Solving a tridiagonal matrix problem like this is a very common operation in computer science, and efficient numerical routines are available in many languages (including Python / <code class="docutils literal notranslate"><span class="pre">numpy</span></code>!)</p>
</section>
<section id="stability-analysis-of-the-implicit-scheme">
<h3><span class="section-number">24.8.2. </span>Stability analysis of the implicit scheme<a class="headerlink" href="#stability-analysis-of-the-implicit-scheme" title="Permalink to this headline">#</a></h3>
<p>We’ll skip the details, but the amplification factor for this scheme is (see <em>Numerical Recipes</em> book or other text on numerical methods):</p>
<div class="math notranslate nohighlight">
\[ \frac{\xi^{n+1}}{\xi^n} = \frac{1}{1+4 K^* \sin^2 \left( \frac{k \Delta x}{2} \right) } \]</div>
<p>so the stability criterion of $<span class="math notranslate nohighlight">\( \bigg| \frac{\xi^{n+1}}{\xi^n} \bigg| \le 1 \)</span>$</p>
<p>is met for any value of <span class="math notranslate nohighlight">\(K^*\)</span> and thus <strong>for any timestep <span class="math notranslate nohighlight">\(\Delta t\)</span></strong>.</p>
<p>The implicit method (also called <strong>backward time</strong>) is unconditionally stable for any choice of timestep.</p>
<hr class="docutils" />
<p><a id='section9'></a></p>
</section>
</section>
<section id="your-homework-assignment">
<h2><span class="section-number">24.9. </span>9. Your homework assignment<a class="headerlink" href="#your-homework-assignment" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<p>Write Python code to solve the diffusion equation using this implicit time method. Demonstrate that it is numerically stable for much larger timesteps than we were able to use with the forward-time method. One way to do this is to use a much higher spatial resolution.</p>
<section id="some-final-thoughts">
<h3><span class="section-number">24.9.1. </span>Some final thoughts:<a class="headerlink" href="#some-final-thoughts" title="Permalink to this headline">#</a></h3>
<p>We have just scratched the surface of the wonders and sorrows of numerical methods here. The implicit method is very <strong>stable</strong> but is not the most <strong>accurate</strong> method for a diffusion problem, particularly when you are interested in some of the faster dynamics of the system (as opposed to just getting the system quickly to its equilibrium state).</p>
<p>There are always trade-offs in the choice of a numerical method.</p>
<p>The equations for most climate models are sufficiently complex that more than one numerical method is necessary. Even in the simple diffusive EBM, the radiation terms are handled by a forward-time method while the diffusion term is solved implicitly.</p>
<p>Once you have worked through the above problem (diffusion only), you might want to look in the <code class="docutils literal notranslate"><span class="pre">climlab</span></code> code to see how the diffusion solver is implemented there, and how it is used when you integrate the EBM.</p>
</section>
</section>
<hr class="docutils" />
<section id="credits">
<h2><span class="section-number">24.10. </span>Credits<a class="headerlink" href="#credits" title="Permalink to this headline">#</a></h2>
<p>This notebook is part of <a class="reference external" href="https://brian-rose.github.io/ClimateLaboratoryBook">The Climate Laboratory</a>, an open-source textbook developed and maintained by <a class="reference external" href="http://www.atmos.albany.edu/facstaff/brose/index.html">Brian E. J. Rose</a>, University at Albany.</p>
<p>It is licensed for free and open consumption under the
<a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0)</a> license.</p>
<p>Development of these notes and the <a class="reference external" href="https://github.com/brian-rose/climlab">climlab software</a> is partially supported by the National Science Foundation under award AGS-1455071 to Brian Rose. Any opinions, findings, conclusions or recommendations expressed here are mine and do not necessarily reflect the views of the National Science Foundation.</p>
<hr class="docutils" />
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./courseware/week7"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="lab23_cesm-atmospheric-dynamics.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">23. </span>Atmospheric Dynamics in the CESM</p>
      </div>
    </a>
    <a class="right-next"
       href="../week8/lab25_albedo-snowball.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">25. </span>Ice-albedo feedback and Snowball Earth in the EBM</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-one-dimensional-diffusion-equation">24.1. 1. The one-dimensional diffusion equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discretizing-the-diffusion-operator-in-space">24.2. 2. Discretizing the diffusion operator in space</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-notation-for-discretization-of-u-x-t">24.2.1. Some notation for discretization of <span class="math notranslate nohighlight">\(u(x,t)\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discretizing-the-diffusive-flux">24.2.2. Discretizing the diffusive flux</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#no-flux-boundary-conditions">24.2.3. No-flux boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-staggered-grid">24.2.4. The staggered grid</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-boundary-condition-on-the-staggered-grid">24.2.5. Implementing the boundary condition on the staggered grid</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-the-discretized-diffusion-operator-in-numpy">24.3. 3. Coding the discretized diffusion operator in <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-smooth-example">24.3.1. A smooth example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-non-smooth-examples">24.3.2. Some non-smooth examples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discretizing-the-time-derivative">24.4. 4. Discretizing the time derivative</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#now-suppose-that-you-wanted-to-double-the-spatial-resolution">24.4.1. Now, suppose that you wanted to <strong>double</strong> the spatial resolution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stability-analysis-of-the-ftcs-scheme">24.5. 5. Stability analysis of the FTCS scheme</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-wavy-solution-must-not-grow-with-time">24.5.1. The wavy solution must not grow with time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-have-just-discovered-an-important-constraint-on-the-allowable-timestep">24.5.2. We have just discovered an important constraint on the allowable timestep</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-tests-with-a-shorter-timestep">24.6. 6. Numerical tests with a shorter timestep</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-need-for-a-more-efficient-method">24.7. 7. The need for a more efficient method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implicit-time-method">24.8. 8. Implicit time method</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-implicit-scheme-as-a-matrix-problem">24.8.1. The implicit scheme as a matrix problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stability-analysis-of-the-implicit-scheme">24.8.2. Stability analysis of the implicit scheme</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#your-homework-assignment">24.9. 9. Your homework assignment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-final-thoughts">24.9.1. Some final thoughts:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#credits">24.10. Credits</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Brian Rose
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>